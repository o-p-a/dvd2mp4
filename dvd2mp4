#! /usr/bin/ruby -E:UTF-8
# -*- mode:Ruby; tab-width:4; coding:UTF-8; -*-
# vi:set ft=ruby ts=4 fenc=UTF-8 :
#----------------------------------------------------------------
# DVD IFO VOBã‚’mp4ã«å¤‰æ›ã™ã‚‹
#
# 2020/06/14 opaâ ğŸ™‚
#----------------------------------------------------------------
ProgName = "dvd2mp4"
Version = "1.04"
#=====dpk===== Copyright2020
Copyright = "Copyright (c) 2020 by opa"
#=====dpk=====
FFMPEG_CMD = "ffmpeg"
FFPROBE_CMD = "ffprobe"
LSDVD_CMD = "lsdvd"

LANGTABLE = {
	"ja" => "jpn",
	"en" => "eng",
	"fr" => "fra",
	"xx" => nil,
}

FF_ANALYZEDURATION = "600M" # 10min
FF_PROBESIZE = "450M" # 450MB

require 'optparse'
require 'open3'
require 'json'
require 'tempfile'
require 'shellwords'
require 'pp'

def var_init
	$PROGRAM_NAME = ProgName
	$metadata = {}
	$rcode = 0
end

def myShellwordsJoin_q(s)
	if s =~ /[\s;&()|^<>?*\[\]$`"\\!{}]/
		return "'" + s.gsub("'") { "'\\''" } + "'"
	else
		return s.gsub("'") { "\\'" }
	end
end

def myShellwordsJoin(args)
	return args.map { |a|
		(a =~ /^(--.+=)(.*)$/) ? myShellwordsJoin_q($1) + myShellwordsJoin_q($2) : myShellwordsJoin_q(a)
	}.join(" ")
end

def sec2hhmmss(sec, full:false)
	r = ""
	d, m = sec.divmod(1) # ç§’ä»¥ä¸‹
	r = sprintf(".%03d", (m * 1000).round)  if m != 0 || full
	d, m = d.divmod(60) # ç§’
	r = sprintf("%02d", m) + r
	if d > 0 || full
		d, m = d.divmod(60) # åˆ†
		r = sprintf("%02d:", m) + r
	end
	if d > 0 || full
		d, m = d.divmod(60) # æ™‚
		r = sprintf("%02d:", m) + r
	end
	return r
end

def pos2sec(pos, fr=nil) # Rational(30000,1001)
	case pos
	when /^([+-]?\d+)f$/
		return $1.to_f / fr
	when /^(\d+):(\d+):(\d+(?:\.\d*)?)$/
		return $1.to_i * 3600 + $2.to_i * 60 + $3.to_f
	when /^(\d+):(\d+(?:\.\d*)?)$/
		return $1.to_i * 60 + $2.to_f
	when /^([+-]?\d+(?:\.\d*)?s?)$/
		return $1.to_f
	else
		fail "ä½ç½®ã®æŒ‡å®šãŒä¸æ­£ã§ã™: #{pos}"
	end
end

def vts_num_to_i(vts_num)
	case vts_num
	when /^VTS_(\d+)$/i, /^v(\d+)$/i
		i = $1.to_i
	else
		fail "'VTS_n'ã®å½¢å¼ã§æŒ‡å®šã—ã¦ãã ã•ã„"
	end
	return i
end

def guess_lang(s)
	case s
	when /(è‹±èª|English)/i
		return "eng"
	when /(æ—¥æœ¬èª|Japanese)/i
		return "jpn"
	end

	return nil
end

def get_vobfiles(vts_num)
	if vts_num >= 1
		vobfiles = Dir.glob(sprintf("VTS_%02d_*.VOB", vts_num), File::FNM_CASEFOLD).sort
		vobfiles.shift  if vobfiles.size >= 2 && vobfiles.first =~ /^VTS_\d+_0\.VOB/i
		fail "å…¥åŠ›VOBãƒ•ã‚¡ã‚¤ãƒ«ãŒã²ã¨ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“"  if vobfiles.empty?
		ifofiles = Dir.glob(sprintf("VTS_%02d_*.IFO", vts_num), File::FNM_CASEFOLD).sort
	elsif vts_num == 0
		vobfiles = Dir.glob("VIDEO_TS.VOB", File::FNM_CASEFOLD).sort
		fail "VIDEO_TS.VOBãŒã‚ã‚Šã¾ã›ã‚“"  if vobfiles.empty?
		ifofiles = Dir.glob("VIDEO_TS.IFO", File::FNM_CASEFOLD).sort
	end
	return [vobfiles, ifofiles]
end

def probe_disc_data_raw
	if !File.exist?("VIDEO_TS.IFO")
		fail "DVDã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“"
	end

	cmd = [LSDVD_CMD]
	cmd += ["-x"]
	cmd += ["-Or", "."]
	r = Open3.capture3(*cmd)

	if r[0].empty?
		printf("%s\n", r[1])
		fail "lsdvdã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ"
	end

	return eval(r[0])
end

def probe_disc_data
	pd = probe_disc_data_raw

	pd[:track].each.with_index(1) do |title, ix|
		fail "lsdvdã®ã‚¿ã‚¤ãƒˆãƒ«æƒ…å ±ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if title[:ix] != ix
		# TODO : ã‚¢ãƒ³ã‚°ãƒ«æƒ…å ±ã®ãƒã‚§ãƒƒã‚¯
		title[:audio].each.with_index(1) do |audio, ix|
			fail "lsdvdã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªæƒ…å ±ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if audio[:ix] != ix
		end
		title[:chapter].each.with_index(1) do |chapter, ix|
			fail "lsdvdã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼æƒ…å ±ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if chapter[:ix] != ix
		end
		title[:cell].each.with_index(1) do |cell, ix|
			fail "lsdvdã®ã‚»ãƒ«æƒ…å ±ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if cell[:ix] != ix
		end
		title[:subp].each.with_index(1) do |subp, ix|
			fail "lsdvdã®å­—å¹•æƒ…å ±ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if subp[:ix] != ix
		end
	end

	vts_wk = {}
	pd[:track].each do |title|
		vts_wk[title[:vts]] ||= []
		vts_wk[title[:vts]] << title
	end
	vts = []
	vts_wk.each do |v, t|
		vts << {vts:v, titles:t}
	end
	vts.sort_by! { |v| v[:vts] }
	vts.each.with_index(1) do |vts, ix|
		fail "ä½¿ã‚ã‚Œã¦ã„ã‚‹VTSç•ªå·ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if vts[:vts] != ix
	end
	pd[:vts] = vts

	if $adjust_fps
		adjust_fps_factor = Rational(30000,1000) / Rational(30000,1001)
		pd[:track].each do |title|
			title[:length] *= adjust_fps_factor
			title[:chapter].each do |chapter|
				chapter[:length] *= adjust_fps_factor
			end
			title[:cell].each do |cell|
				cell[:length] *= adjust_fps_factor
			end
		end
	end

	return pd
end

def probe_vts_data_raw(vts_num)
	vobfiles, ifofiles = get_vobfiles(vts_num)

	cmd1 = ["cat"]
	cmd1 += vobfiles

	cmd2 = [FFPROBE_CMD]
	cmd2 += ["-hide_banner"]
	cmd2 += ["-loglevel", "warning"]
	cmd2 += ["-analyzeduration", FF_ANALYZEDURATION]
	cmd2 += ["-probesize", FF_PROBESIZE]
	cmd2 += ["-print_format", "json"]
	cmd2 += ["-show_format"]
	cmd2 += ["-show_streams"]
	cmd2 += ["-i", "-"]
	return JSON.parse(Open3.pipeline_r(cmd1, cmd2)[0].read, symbolize_names:true)
end

def probe_vts_data(vts_num)
	disc = probe_disc_data
	if vts_num >= 1
		if !disc[:vts][vts_num - 1]
			fail sprintf("VTS_%02dã®æƒ…å ±ã¯ã‚ã‚Šã¾ã›ã‚“", vts_num)
		end
		titles = disc[:vts][vts_num - 1][:titles]
	else
		titles = []
	end

	# ã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±ã®å–å¾—
	vobfiles, ifofiles = get_vobfiles(vts_num)

	cmd1 = ["cat"]
	cmd1 += vobfiles

	cmd2 = [FFPROBE_CMD]
	cmd2 += ["-hide_banner"]
	cmd2 += ["-loglevel", "error"]
	cmd2 += ["-analyzeduration", FF_ANALYZEDURATION]
	cmd2 += ["-probesize", FF_PROBESIZE]
	cmd2 += ["-print_format", "json"]
	cmd2 += ["-show_format"]
	cmd2 += ["-show_streams"]
	cmd2 += ["-i", "-"]
	ffprobe = JSON.parse(Open3.pipeline_r(cmd1, cmd2)[0].read, symbolize_names:true)

	streams = ffprobe[:streams]
	streams_v = []
	streams_a = []
	streams_s = []
	streamids = {}
	streams.each.with_index(1) do |stream, ix|
		fail "ffprobeã§ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ç•ªå·ã«é£›ã³ç•ªãŒã‚ã‚Šã¾ã™"  if stream[:index] != ix-1
		stream[:ix] = ix
		fail "ffprobeã§ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ IDã«é‡è¤‡ãŒã‚ã‚Šã¾ã™"  if streamids.include?(stream[:id].to_i(0))
		streamids[stream[:id].to_i(0)] = true

		case stream[:codec_type]
		when "video"
			streams_v << stream
		when "audio"
			streams_a << stream

			streamid = stream[:id].to_i(0)
			lsdvd = nil
			titles.each do |title|
				title[:audio].each do |audio|
					if audio[:streamid].to_i(0) == streamid
						lsdvd = audio
						break
					end
				end
				break  if lsdvd
			end
			if lsdvd
				stream[:langcode] = lsdvd[:langcode]
				stream[:language] = lsdvd[:language]
				stream[:content] = lsdvd[:content]
				stream[:lang] = LANGTABLE[stream[:langcode]]
				fail sprintf("è¨€èªã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›ã§ãã¾ã›ã‚“: %s", stream[:langcode])  if !LANGTABLE.include?(stream[:langcode])
			end
		when "subtitle"
			streams_s << stream

			streamid = stream[:id].to_i(0)
			lsdvd = nil
			titles.each do |title|
				title[:subp].each do |subp|
					if subp[:streamid].to_i(0) == streamid
						lsdvd = subp
						break
					end
				end
				break  if lsdvd
			end
			if lsdvd
				stream[:langcode] = lsdvd[:langcode]
				stream[:language] = lsdvd[:language]
				stream[:content] = lsdvd[:content]
				stream[:lang] = LANGTABLE[stream[:langcode]]
				fail sprintf("è¨€èªã‚³ãƒ¼ãƒ‰ãŒå¤‰æ›ã§ãã¾ã›ã‚“: %s", stream[:langcode])  if !LANGTABLE.include?(stream[:langcode])
			end
		when "data"
			# NOP
		else
			fail "ä¸æ˜ãªcodec_typeã§ã™: #{stream[:codec_type]}"
		end
	end

	# ã‚»ãƒ«ä¸€è¦§ã‚’ä½œæˆ
	cells = []
	ctmap = {0 => 0.0}
	titles.each do |title|
		title[:cell].each do |cell|
			if !cells.find { |c|
				c[:first_sector] == cell[:first_sector] &&
				c[:last_sector] == cell[:last_sector]
			}
				cells << {
					ix: nil,
					start: nil,
					end: nil,
					length: cell[:length],
					first_sector: cell[:first_sector],
					last_sector: cell[:last_sector],
				}
			end
		end
	end
	cells.sort_by! { |c| c[:first_sector] }
	# å…ˆé ­ã‹ã‚‰é †ã«é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ã‚’ç‰¹å®š
	cells.each.with_index(1) do |cell, ix|
		startsec = ctmap[cell[:first_sector]]
		if !startsec
			startsec = ctmap.max[1]
			ctmap[cell[:first_sector]] = startsec
			printf("ã‚»ãƒ«æƒ…å ±ãŒä¸é€£ç¶šã®ãŸã‚ã€é–‹å§‹æ™‚åˆ»ã‚’ç¢ºå®šã§ãã¾ã›ã‚“\n")
		end
		endsec = startsec + cell[:length]

		cell[:ix] = ix
		cell[:start] = startsec
		ctmap[cell[:last_sector] + 1] = endsec
		cell[:end] = endsec
	end

	# chapter_offset ã‚’ç®—å‡º
	framerate = Rational(streams_v.first[:avg_frame_rate])
	chapter_offset = $chapter_offset ? pos2sec($chapter_offset, framerate) : 0

	# ãƒãƒ£ãƒ—ã‚¿ãƒ¼ä¸€è¦§ã‚’ä½œæˆ
	chapters = []
	titles.each do |title|
		title[:chapter].each do |chapter|
			cell = title[:cell][chapter[:startcell]-1]
			if !chapters.find { |c|
				c[:length] == chapter[:length] &&
				c[:first_sector] == cell[:first_sector]
			}
				chapters << {
					ix: nil,
					title_ix_in_vts: title[:ix],
					chapter_ix_in_title: chapter[:ix],
					start: nil,
					end: nil,
					length: chapter[:length],
					first_sector: cell[:first_sector],
				}
			end
		end
	end
	chapters.sort_by! { |c| c[:first_sector] }
	# ãƒãƒ£ãƒ—ã‚¿ãƒ¼é–‹å§‹ä½ç½®,çµ‚äº†ä½ç½®ã‚’æ±ºå®š
	chapters.each.with_index(1) do |chapter, ix|
		startsec = ctmap[chapter[:first_sector]]
		fail "ãƒãƒ£ãƒ—ã‚¿ãƒ¼é–‹å§‹æ™‚åˆ»ã‚’ç¢ºå®šã§ãã¾ã›ã‚“"  if !startsec
		endsec = startsec + chapter[:length]

		startsec += chapter_offset
		startsec = 0  if startsec < 0
		endsec += chapter_offset
		endsec = 0  if endsec < 0
		length = endsec - startsec

		chapter[:ix] = ix
		chapter[:start] = startsec
		chapter[:end] = endsec
		chapter[:length] = length
	end
	# æ¬¡ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’çªãæŠœã‘ã¦ã—ã¾ã£ã¦ã„ã‚‹ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’èª¿æ•´
	chapters.each_with_index do |chapter, i|
		next_chapter = chapters[i+1]
		break  if !next_chapter

		if chapter[:end] > next_chapter[:start]
			chapter[:end] = next_chapter[:start]
			chapter[:length] = chapter[:end] - chapter[:start]
		end
	end
	# æŒ‡å®šé•·ã‚ˆã‚ŠçŸ­ã„ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å‰Šé™¤
	prev_chapter = nil
	chapters.each do |chapter|
		if prev_chapter && chapter[:length] < $delete_chpt_sec
			prev_chapter[:length] += chapter[:length]
			prev_chapter[:end] += chapter[:length]
			chapter[:start] += chapter[:length]
			chapter[:length] = 0
		else
			prev_chapter = chapter
		end
	end
	# é•·ã•0ã®ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å‰Šé™¤
	chapters.delete_if { |c| c[:length] == 0 }

	return {
		disc: disc,
		vts_num: vts_num,
		titles: titles,
		chapters: chapters,
		vobfiles: vobfiles,
		ifofiles: ifofiles,
		format: ffprobe[:format],
		streams: streams,
		streams_v: streams_v,
		streams_a: streams_a,
		streams_s: streams_s,
	}
end

def measure_vob_duration(vts_num)
	vobfiles, = get_vobfiles(vts_num)

	vobtime = 0
	vobfiles.each do |vobfile|
		cmd = [FFPROBE_CMD]
		cmd += ["-hide_banner"]
		cmd += ["-loglevel", "warning"]
		cmd += ["-print_format", "json"]
		cmd += ["-show_format"]
		cmd += ["-i", vobfile]
		r = Open3.capture3(*cmd)
		ffprobe = JSON.parse(r[0], symbolize_names:true)
		vobtime += ffprobe[:format][:duration].to_f
	end

	return vobtime
end

def measure_strict_duration(vts_num)
	printf("Measuring strict VTS duration...\n")

	vobfiles, = get_vobfiles(vts_num)
	wfile = Tempfile.new(["vtsmeasure", ".wav"])

	cmd1 = ["cat"]
	cmd1 += vobfiles

	cmd2 = [FFMPEG_CMD]
	cmd2 += ["-hide_banner"]
	cmd2 += ["-loglevel", "error"]
	cmd2 += ["-y"]
	cmd2 += ["-i", "-"]
	cmd2 += ["-f", "wav"]
	cmd2 += ["-ac", "1"] # ãƒ¢ãƒãƒ©ãƒ«
	cmd2 += ["-codec:a", "pcm_u8"]
	cmd2 += [wfile.path]
	Open3.pipeline(cmd1, cmd2)

	cmd3 = [FFPROBE_CMD]
	cmd3 += ["-hide_banner"]
	cmd3 += ["-loglevel", "warning"]
	cmd3 += ["-print_format", "json"]
	cmd3 += ["-show_format"]
	cmd3 += ["-i", wfile.path]
	ffprobe = JSON.parse(Open3.capture3(*cmd3)[0], symbolize_names:true)

	return ffprobe[:format][:duration].to_f
end

def probe_disc
	pd = probe_disc_data

	printf("disc title : %s\n", pd[:title])  if pd[:title] != "unknown"
	printf("vmg_id : %s\n", pd[:vmg_id])  if pd[:vmg_id] != "DVDVIDEO-VMG"
	printf("provider id : %s\n", pd[:provider_id])  if pd[:provider_id] != ""

	pd[:vts].each do |vts|
		printf("VTS_%02d :", vts[:vts])
		vts[:titles].each_with_index do |title, i|
			if i == 0
				printf(" %dx%d(%s) %0.2ffps", title[:width], title[:height], title[:aspect], title[:fps])
			else
				print("                               ")
			end
			printf(" Title %d %s(%0.1fs)", title[:ix], sec2hhmmss(title[:length], full:true), title[:length])
			aux = ""
			aux += sprintf(" angle:%d", title[:angles])  if title[:angles] != 1
			aux += sprintf(" audio:%d", title[:audio].size)  if title[:audio].size != 1
			aux += sprintf(" subt:%d", title[:subp].size)  if title[:subp].size != 0
			aux += sprintf(" chpt:%d", title[:chapter].size)  if title[:chapter].size != 1
			aux += sprintf(" longest")  if title[:ix] == pd[:longest_track]
			print(" /" + aux)  if !aux.empty?
			print("\n")
		end
	end
end

def probe_vts(vts_num)
	pd = probe_vts_data(vts_num)

	if $strict_length
		video_duration = measure_strict_duration(vts_num)
	else
		video_duration = measure_vob_duration(vts_num)
	end

	printf("VTS_%02d :", vts_num)

	if pd[:streams_v].size != 1
		fail "æƒ³å®šå¤–ã®ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ æ•°: #{pd[:streams_v].size}"
	end

	video = pd[:streams_v].first
	printf(" %dx%d(%s)", video[:width], video[:height], video[:display_aspect_ratio])
	printf(" %0.2ffps", Rational(video[:avg_frame_rate]).to_f)
	printf(" %s", video[:field_order])
	printf(" %s(%0.3fs)", sec2hhmmss(video_duration, full:true), video_duration)

	aux = ""
	#aux += sprintf(" angle:%d", pd[:angles])  if track[:angles] != 1
	aux += sprintf(" audio:%d", pd[:streams_a].size)  if pd[:streams_a].size != 1
	aux += sprintf(" subt:%d", pd[:streams_s].size)  if pd[:streams_s].size != 0
	aux += sprintf(" chpt:%d", pd[:chapters].size)  if pd[:chapters].size != 1
	print(" /" + aux)  if !aux.empty?
	print("\n")

	pd[:disc][:track].each do |title|
		next  if title[:vts] != vts_num
		if title[:angles] != 1
			printf("Angle %d :", 1)
			print(" è¤‡æ•°ã‚¢ãƒ³ã‚°ãƒ«ãŒã‚ã‚Šã¾ã™\n")
		end
	end

	pd[:streams_a].each.with_index(1) do |audio, ix|
		printf("Audio %d :", ix)
		printf(" %s %s %dHz %dch", audio[:language], audio[:codec_long_name], audio[:sample_rate], audio[:channels])
		printf(" %s", audio[:content])  if audio[:content] && !audio[:content].empty? && audio[:content] != "Undefined"
		print("\n")
	end

	pd[:streams_s].each.with_index(1) do |subp, ix|
		printf("Subtitle %d :", ix)
		printf(" %s", subp[:language])
		printf(" %s", subp[:content])  if subp[:content] && !subp[:content].empty? && subp[:content] != "Undefined"
		print("\n")
	end

	pd[:chapters].each.with_index(1) do |chapter, ix|
		printf("Chapter %d :", ix)
		printf(" %s - %s %s(%0.3fs)", sec2hhmmss(chapter[:start], full:true), sec2hhmmss(chapter[:end], full:true),
		 							sec2hhmmss(chapter[:length]), chapter[:length])
		print("\n")
	end

	pd[:disc][:track].each do |title|
		next  if title[:vts] != vts_num

		if title[:angles] > pd[:streams_v].size
			printf("ã‚¿ã‚¤ãƒˆãƒ«%dã®ã‚¢ãƒ³ã‚°ãƒ«ã¯%då€‹ã§ã™ãŒã€ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯%då€‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“\n",
				title[:ix], title[:angles], pd[:streams_v].size)
		end
		if title[:audio].size > pd[:streams_a].size
			printf("ã‚¿ã‚¤ãƒˆãƒ«%dã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒãƒ£ãƒãƒ«ã¯%då€‹ã§ã™ãŒã€ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯%då€‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“\n",
				title[:ix], title[:audio].size, pd[:streams_a].size)
		end
		if title[:subp].size > pd[:streams_s].size
			printf("ã‚¿ã‚¤ãƒˆãƒ«%dã®å­—å¹•æ•°ã¯%då€‹ã§ã™ãŒã€å­—å¹•ã‚¹ãƒˆãƒªãƒ¼ãƒ ã¯%då€‹ã—ã‹ã‚ã‚Šã¾ã›ã‚“\n",
				title[:ix], title[:subp].size, pd[:streams_s].size)
		end
	end
end

def dvd2mp4(vts_num)
	pd = probe_vts_data(vts_num)
	vs1 = pd[:streams_v].first
	framerate = Rational(vs1[:avg_frame_rate])
	vts_begin_sec = pd[:chapters].map{ |c| c[:start] }.min
	vts_end_sec = pd[:chapters].map{ |c| c[:end] }.max
	output_ranges = []

	# é–‹å§‹:çµ‚äº†ä½ç½®ã‚’æ±ºå®š
	start_offset = $start_pos ? pos2sec($start_pos, framerate) : vts_begin_sec
	end_offset = $end_pos ? pos2sec($end_pos, framerate) : vts_end_sec
	end_offset = start_offset + pos2sec($duration, framerate)  if $duration
	end_offset = start_offset  if end_offset < start_offset

	# å‡ºåŠ›ç¯„å›²ãŒãªã«ã‚‚æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€# æœ€åˆã‹ã‚‰æœ€å¾Œã¾ã§ã‚’1ã¤ã®å¡Šã§å‡ºåŠ›
	if !$output_chapters && !$output_ranges
		output_ranges << (vts_begin_sec .. vts_end_sec)
	end

	# ãƒãƒ£ãƒ—ã‚¿ãƒ¼å˜ä½ã®å‡ºåŠ›ç¯„å›²ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
	if $output_chapters
		if $output_chapters.empty? # æœ€åˆã‹ã‚‰æœ€å¾Œã¾ã§ã‚’ãƒãƒ£ãƒ—ã‚¿ãƒ¼æ¯ã«ãƒãƒ©ãƒãƒ©ã§å‡ºåŠ›
			pd[:chapters].each do |chapter|
				output_ranges << (chapter[:start] .. chapter[:end])
			end
		else # æŒ‡å®šã•ã‚ŒãŸã¨ãŠã‚Šã«å‡ºåŠ›
			$output_chapters.each do |oc|
				if oc.is_a?(Range)
					b = oc.begin
					e = oc.end
				else
					b = e = oc
				end
				# ãƒãƒ£ãƒ—ã‚¿ãƒ¼ç•ªå·ã‚’ä¸Šé™ä¸‹é™ã«ãŠã•ã‚ã‚‹
				b = b.clamp(0, pd[:chapters].length-1)
				e = e.clamp(0, pd[:chapters].length-1)
				# ãƒãƒ£ãƒ—ã‚¿ãƒ¼ç•ªå·ã‹ã‚‰ç§’ã¸å¤‰æ›
				b = pd[:chapters][b][:start]
				e = pd[:chapters][e][:end]
				output_ranges << (b .. e)
			end
		end
	end

	# ç§’å˜ä½ã®å‡ºåŠ›ç¯„å›²ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
	if $output_ranges
		$output_ranges.each do |range|
			if range =~ /^(.*)-(.*)$/
				b = pos2sec($1, framerate)
				e = pos2sec($2, framerate)
			else
				b = pos2sec(range, framerate)
				e = vts_end_sec
			end
			b = b.clamp(vts_begin_sec, vts_end_sec)
			e = e.clamp(vts_begin_sec, vts_end_sec)
			output_ranges << (b .. e)
		end
	end

	# é–‹å§‹æ™‚åˆ»é †ã«ä¸¦ã¹æ›¿ãˆ
	output_ranges.sort_by! { |r| r.begin }

	# æ¬¡ã®å‡ºåŠ›ç¯„å›²ã‚’çªãæŠœã‘ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’èª¿æ•´
	r_limit = vts_end_sec
	work_ranges = []
	output_ranges.reverse_each do |r|
		work_ranges << (r.begin .. (r.end > r_limit ? r_limit : r.end))
		r_limit = r.begin
	end
	work_ranges.sort_by! { |r| r.begin }
	output_ranges.replace(work_ranges)

	# é–‹å§‹:çµ‚äº†ä½ç½®ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆèª¿æ•´
	output_ranges.map! do |r|
		b = r.begin + start_offset
		if b > r.end
			b = r.end
		end
		e = r.end
		if (r.end - r.begin) > end_offset
			e = r.begin + end_offset
		end
		if e < b
			e = b
		end
		(b .. e)
	end

	# é•·ã•0ã®ç¯„å›²ã‚’å‰Šé™¤
	output_ranges.delete_if { |r| r.begin >= r.end }

	if output_ranges.length < 1
		fail "å‡ºåŠ›å¯¾è±¡ç¯„å›²ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
	end

	# ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¡ã‚¿æƒ…å ±ã‚’æ±ºå®š
	if !$metadata[:album_name]
		if pd[:disc][:title] && pd[:disc][:title] != "unknown"
			$stdout.printf("ã‚¢ãƒ«ãƒãƒ åã‚’ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±ã‹ã‚‰å–å¾—ã—ã¾ã™: %s\n", pd[:disc][:title])
			$metadata[:album_name] = pd[:disc][:title]
		end
	end

	if !$metadata[:title_name]
		$stdout.printf("ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n")
	end

	# å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒ™ãƒ¼ã‚¹éƒ¨åˆ†ã‚’ç”Ÿæˆ
	if $metadata[:title_name]
		if $metadata[:title_num]
			dst_basename = "#{$metadata[:title_num]} #{$metadata[:title_name]}".strip
		else
			dst_basename = "#{$metadata[:title_name]}"
		end
	else
		dst_basename = sprintf("VTS_%02d", vts_num)
	end
	if $testmode
		dst_basename = "(test)" + dst_basename
	end

	# ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ãƒ¡ã‚¿æƒ…å ±ã‚’æ±ºå®š
	pd[:streams_v].each_with_index do |stream, ix|
		title = $metadata[:s_video_name][ix]
		# if !title
		# 	$stdout.printf("ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ  #{ix+1} ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n")
		# 	title = "#{stream[:codec_long_name]} #{stream[:width]}x#{stream[:height]} #{stream[:display_aspect_ratio]}".strip
		# end
		stream[:title] = title
	end

	pd[:streams_a].each_with_index do |stream, ix|
		title = $metadata[:s_audio_name][ix]
		if !title
			$stdout.printf("ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ  #{ix+1} ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n")
			if stream[:lang]
				title = "#{stream[:language]} #{stream[:channel_layout]}".strip
			else
				title = "#{stream[:channel_layout]}".strip
			end
		else
			if !stream[:lang]
				stream[:lang] = guess_lang(title)
			end
		end
		stream[:title] = title
	end

	pd[:streams_s].each_with_index do |stream, ix|
		title = $metadata[:s_subtitle_name][ix]
		if !title
			$stdout.printf("å­—å¹•ã‚¹ãƒˆãƒªãƒ¼ãƒ  #{ix+1} ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n")
			title = "#{stream[:language]}"
		else
			if !stream[:lang]
				stream[:lang] = guess_lang(title)
			end
		end
		stream[:title] = title
	end

	# ãƒãƒ£ãƒ—ã‚¿ãƒ¼åã‚’æ±ºå®š
	pd[:chapters].each_with_index do |chapter, ix|
		title = $metadata[:chapter_name][ix]
		if !title
			$stdout.printf("ãƒãƒ£ãƒ—ã‚¿ãƒ¼ #{ix+1} ã®ã‚¿ã‚¤ãƒˆãƒ«ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“\n")
		end
		chapter[:title] = title
	end

	# å‡ºåŠ›ã™ã‚‹ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®æ•°ã‚’ç¨®é¡ã”ã¨ã«æ•°ãˆã‚‹
	streams_v_output = pd[:streams_v].count { |s| s[:title] != "omit" }
	streams_a_output = pd[:streams_a].count { |s| s[:title] != "omit" }
	streams_s_output = pd[:streams_s].count { |s| s[:title] != "omit" }

	codec_count = {}
	# å¯¾è±¡VOB,IFOã®æ±ºå®š & ãƒ¯ãƒ¼ã‚¯VOBã®ä½œæˆ
	if $dryrun
		vobfile = pd[:vobfiles].first
	else
		vobfile = Tempfile.new(["dvd2mp4", ".vob"]).path

		if $simple_concat
			cmd = ["cat"]
			cmd += pd[:vobfiles]
			printf("Writing work VOB(simple)...\n")
			system(*cmd, out:vobfile)
			fail "#{$?}"  if $? != 0
			printf("...Complete.\n")
		else
			cmd1 = ["cat"]
			cmd1 += pd[:vobfiles]

			cmd2 = [FFMPEG_CMD]
			cmd2 += ["-hide_banner"]
			cmd2 += ["-loglevel", "error"]
			cmd2 += ["-analyzeduration", FF_ANALYZEDURATION]
			cmd2 += ["-probesize", FF_PROBESIZE]
			cmd2 += ["-y"]
			cmd2 += ["-i", "-"]
			cmd2 += ["-codec", "copy"]
			cmd2 += ["-map", "0", "-map", "-0:d"]
			cmd2 += ["-f", "vob"]
			cmd2 += [vobfile]

			printf("Writing work VOB...\n")
			Open3.pipeline(cmd1, cmd2)
			# fail "#{$?}"  if $? != 0
			printf("...Complete.\n")

			# å·»ãç›´ã™ã¨Stream IDãŒå¤‰ã‚ã‚‹ã®ã§èª¿æ•´
			pd[:streams_a].each do |stream|
				src_sid = stream[:id]
				codec_count[stream[:codec_name]] ||= 0
				case stream[:codec_name]
				when "ac3"
					new_sid = sprintf("0x%02x", 0x80 + codec_count["ac3"])
				when "dts"
					new_sid = sprintf("0x%02x", 0x88 + codec_count["dts"])
				else
					fail "æƒ³å®šå¤–ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ¼ãƒ‡ãƒƒã‚¯ : #{stream[:codec_name]}"
				end

				stream[:id] = new_sid

				codec_count[stream[:codec_name]] += 1
			end
		end
	end

	ifofile = pd[:ifofiles].first

	# å¤‰æ›ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—
	output_ranges.each do |output_range|
		start_sec = output_range.begin
		end_sec = output_range.end

		# ãƒãƒ£ãƒ—ã‚¿ãƒ¼æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
		chapters_output = 0
		cfile = Tempfile.new(["chapter", ".txt"])
		cfile.printf(";FFMETADATA1\n")
		pd[:chapters].each.with_index(1) do |chapter, ix|
			next  if chapter[:title] == "omit"
			next  if chapter[:end] <= (start_sec + 0.5)
			next  if chapter[:start] >= (end_sec - 0.5)

			cfile.printf("[CHAPTER]\n")
			cfile.printf("TIMEBASE=1/1000000\n")
			cfile.printf("START=%d\n", chapter[:start] * 1000000)
			cfile.printf("END=%d\n", chapter[:end] * 1000000)
			cfile.printf("title=%s\n", chapter[:title] || "Chapter #{ix}")

			chapters_output += 1
		end
		cfile.flush
		system("cat", cfile.path)  if $dryrun

		# å¤‰æ›ã‚³ãƒãƒ³ãƒ‰ç”Ÿæˆ
		cmd = [FFMPEG_CMD]
		cmd += ["-hide_banner"]
		cmd += ["-loglevel", "info"]
		cmd += ["-analyzeduration", FF_ANALYZEDURATION]
		cmd += ["-probesize", FF_PROBESIZE]
		cmd += ["-y"]  if $overwrite || $testmode
		cmd += ["-ifo_palette", ifofile]  if ifofile && (streams_s_output >= 1)
		cmd += ["-ss", start_sec.to_s]  if !$simple_concat
		cmd += ["-i", vobfile] # #0

		if chapters_output >= 2
			cmd += ["-ss", start_sec.to_s]  if !$simple_concat
			cmd += ["-i", cfile.path] # #1
			cmd += ["-map_chapters", "1"]
		end

		cmd += ["-ss", start_sec.to_s]  if $simple_concat
		cmd += ["-t", (end_sec - start_sec).to_s]
		cmd += ["-f", "mp4"]
		cmd += ["-movflags", "+faststart+disable_chpl"]
		cmd += ["-metadata", "album=#{$metadata[:album_name]}"]  if $metadata[:album_name]
		cmd += ["-metadata", "track=#{$metadata[:title_num]}"]  if $metadata[:title_num]
		cmd += ["-metadata", "title=#{$metadata[:title_name]}"]  if $metadata[:title_name]
		cmd += ["-metadata", "encoding_tool=#{$commandline}"]

		if streams_v_output >= 1
			filters_v = []

			cmd += ["-preset:v", $testmode ? "ultrafast" : "veryslow"]
			cmd += ["-tune:v", $video_tune]  if $video_tune
			cmd += ["-pix_fmt:v", "yuv420p"]
			cmd += ["-crf:v", $crf.to_s]
			if $quality_v == "l"
				cmd += ["-maxrate:v", "1.0M"]
				cmd += ["-bufsize:v", "2.5M"]
			end

			if $pullup24
				# 24fpsã«å¤‰æ›
				if Rational(framerate).denominator == 1001
					framerate24 = "24000/1001"
				else
					framerate24 = "24"
				end

				filters_v << "fieldmatch"
				filters_v << "bwdif=mode=send_frame:deint=interlaced"
				filters_v << "fps=fps=#{framerate24}:round=#{$pullup24}"
			else
				# ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ¬ãƒ¼ã‚¹è§£é™¤
				if $force_deinterlace || (vs1[:field_order] && vs1[:field_order] != "progressive")
					filters_v << ($testmode ? "bwdif=mode=send_frame" : "bwdif=mode=send_field")
				end
			end

			# ãƒã‚¤ã‚ºé™¤å»
			case $video_tune
			when "animation"
				filters_v << "hqdn3d"
			else
				filters_v << "vaguedenoiser"
			end

			# é»’ãƒ¬ãƒ™ãƒ«, ç™½ãƒ¬ãƒ™ãƒ«
			if $whitepoint || $blackpoint
				w = $whitepoint ? [$whitepoint[0] || 1, $whitepoint[1] || 1, $whitepoint[2] || 1] : [1,1,1]
				b = $blackpoint ? [$blackpoint[0] || 0, $blackpoint[1] || 0, $blackpoint[2] || 0] : [0,0,0]
				filters_v << "colorlevels=rimin=#{b[0]}:gimin=#{b[1]}:bimin=#{b[2]}:rimax=#{w[0]}:gimax=#{w[1]}:bimax=#{w[2]}"
			end

			# ã‚¬ãƒ³ãƒ, å½©åº¦
			if $video_gamma || $video_saturation
				eq = []
				eq << "gamma=#{$video_gamma}"  if $video_gamma
				eq << "saturation=#{$video_saturation}"  if $video_saturation
				filters_v << "eq=#{eq.join(":")}"
			end

			# ã‚¯ãƒªãƒƒãƒ”ãƒ³ã‚°
			if $video_crop
				in_w = vs1[:width]
				in_h = vs1[:height]
				crop_w = in_w - ($video_crop[2] + $video_crop[3])
				crop_h = in_h - ($video_crop[0] + $video_crop[1])
				crop_x = $video_crop[2]
				crop_y = $video_crop[0]
				out_w = in_w
				out_h = (crop_h > 360) ? in_h : 360
				filters_v << "crop=w=#{crop_w}:h=#{crop_h}:x=#{crop_x}:y=#{crop_y}:keep_aspect=1"
				filters_v << "scale=w=#{out_w}:h=#{out_h}"
			end

			# å›è»¢
			case $video_rotate
			when 90
				filters_v << "transpose=clock"
			when 180
				filters_v << "hflip" << "vflip"
			when 270
				filters_v << "transpose=cclock"
			end

			# ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”
			if $video_aspect
				filters_v << "setdar=#{$video_aspect.gsub(":", "/")}"
			end

			cmd += ["-filter:v", filters_v.join(",")]  if filters_v.size > 0
		end

		if streams_a_output >= 1
			if $flac_audio
				cmd += ["-codec:a", "flac", "-strict", "experimental"]
			else
				cmd += ["-codec:a", "libfdk_aac"]
				cmd += ["-profile:a", "aac_low"]

				case $quality_a
				when "h"
					cmd += ["-vbr:a", "5"]
				when "l"
					cmd += ["-vbr:a", "1"]
					cmd += ["-cutoff:a", "14000"]
				else
					cmd += ["-vbr:a", "3"]
					cmd += ["-cutoff:a", "18000"]
				end
			end
		end

		if streams_s_output >= 1
			cmd += ["-codec:s", "dvd_subtitle"]
		end

		# ã‚¹ãƒˆãƒªãƒ¼ãƒ æ¯ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æŒ‡å®š
		scount = 0

		pd[:streams_v].each do |stream|
			next  if stream[:title] == "omit"

			cmd += ["-map", "##{stream[:id]}"]

			if streams_v_output >= 2
				cmd += ["-metadata:s:#{scount}", "language=#{stream[:lang]}"]
				cmd += ["-metadata:s:#{scount}", "title=#{stream[:title]}"]
				cmd += ["-metadata:s:#{scount}", "handler_name=#{stream[:title]}"]
			end

			scount += 1
		end

		pd[:streams_a].each do |stream|
			next  if stream[:title] == "omit"

			cmd += ["-map", "##{stream[:id]}"]

			# if streams_a_output >= 2
				cmd += ["-metadata:s:#{scount}", "language=#{stream[:lang]}"]
				cmd += ["-metadata:s:#{scount}", "title=#{stream[:title]}"]
				cmd += ["-metadata:s:#{scount}", "handler_name=#{stream[:title]}"]
			# end

			scount += 1
		end

		pd[:streams_s].each do |stream|
			next  if stream[:title] == "omit"

			cmd += ["-map", "##{stream[:id]}"]

			# if streams_s_output >= 2
				cmd += ["-metadata:s:#{scount}", "language=#{stream[:lang]}"]
				cmd += ["-metadata:s:#{scount}", "title=#{stream[:title]}"]
				cmd += ["-metadata:s:#{scount}", "handler_name=#{stream[:title]}"]
			# end

			scount += 1
		end

		# TODO:ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ

		if $dryrun
			cmd += [dst_basename + ".mp4"]
			p cmd
		else
			# ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ±ºå®š
			dst_filename = 1.step do |n|
				f = dst_basename + (n == 1 ? "" : " #{n}") + ".mp4"
				break f  if !File.exist?(f)
			end

			dst_filename2 = dst_filename
			cmd += [dst_filename2]
			system(*cmd)
			fail "#{$?}"  if $? != 0

			if File.exist?(dst_filename2)
				timestamp_src = (pd[:ifofiles] + pd[:vobfiles]).first
				File.utime(File.atime(timestamp_src), File.mtime(timestamp_src), dst_filename2)
#				File.rename(dst_filename2, dst_filename)
			end
		end
	end
end

def show_encoding_tool(filename)
	cmd = [FFPROBE_CMD]
	cmd += ["-hide_banner"]
	cmd += ["-loglevel", "warning"]
	cmd += ["-print_format", "json"]
	cmd += ["-show_format"]
	cmd += ["-i", filename]
	format = JSON.parse(Open3.capture3(*cmd)[0], symbolize_names:true)

	printf("%s\n", format[:format][:tags][:encoder])
end

def main(args)
	var_init
	$commandline = ProgName + " " + myShellwordsJoin(args)

	args.options do |opt|
		opt.banner = "#{ProgName} v#{Version} #{Copyright}\n" +
						"Usage: #{ProgName} [options] VTS_nn..."

		$probe = false
		opt.on("-p", "--[no-]probe",
			"ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹") do |v|
			$probe = v
		end

		$probe_raw = false
		opt.on("-r", "--[no-]probe-raw",
			"ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹(éç·¨é›†)") do |v|
			$probe_raw = v
		end

		$start_pos = nil
		opt.on("-s", "--startpoint=pos", String,
			"é–‹å§‹ä½ç½®ã‚’æŒ‡å®šã™ã‚‹(ç§’/æ™‚åˆ†ç§’/ãƒ•ãƒ¬ãƒ¼ãƒ )") do |v|
			$start_pos = v
		end

		$end_pos = nil
		opt.on("-e", "--endpoint=pos", String,
			"çµ‚äº†ä½ç½®ã‚’æŒ‡å®šã™ã‚‹") do |v|
			$end_pos = v
			$duration = nil
		end

		$duration = nil
		opt.on("-d", "--duration=dur", String,
			"å‡ºåŠ›ã™ã‚‹é•·ã•ã‚’æŒ‡å®šã™ã‚‹") do |v|
			$duration = v
			$end_pos = nil
		end

		$output_ranges = nil
		opt.on("--split-at=n,n-n,...", String,
			"å‡ºåŠ›ã™ã‚‹ç¯„å›²ã‚’æŒ‡å®šã™ã‚‹") do |v|
			$output_ranges = v.split(",").map do |r|
				case r
				when /^(.*)-(.*)$/
					pos2sec($1, 30)
					pos2sec($2, 30)
					r
				else
					pos2sec(r, 30)
					r
				end
			end
		end

		$output_chapters = nil
		opt.on("--chapter=n,n-n,...", String,
			"å‡ºåŠ›ã™ã‚‹ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’æŒ‡å®šã™ã‚‹") do |v|
			$output_chapters = v.split(",").map do |c|
				case c
				when /^\s*(\d+)\s*$/
					$1.to_i-1
				when /^\s*(\d+)\s*-\s*(\d+)\s*$/
					($1.to_i-1) .. ($2.to_i-1)
				else
					nil
				end
			end
		end
		opt.on("--[no-]split-chapter",
			"ãƒãƒ£ãƒ—ã‚¿ãƒ¼æ¯ã«åˆ†å‰²ã—ã¦å‡ºåŠ›ã™ã‚‹") do |v|
			$output_chapters = v ? [] : nil
		end

		$delete_chpt_sec = 0
		opt.on("--delete-short-chapter=n", Float,
			"nç§’ã‚ˆã‚ŠçŸ­ã„ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹") do |v|
			$delete_chpt_sec = (v<0) ? 0 : v
		end

		$chapter_offset = nil
		opt.on("--chapter-offset=n", String,
			"ãƒãƒ£ãƒ—ã‚¿ãƒ¼ãƒãƒ¼ã‚¯ã‚’å…¨ä½“çš„ã«ç§»å‹•ã™ã‚‹") do |v|
			$chapter_offset = v
		end

		$metadata[:album_name] = nil
		opt.on("--album-name=str", String,
			"ã‚¢ãƒ«ãƒãƒ åã‚’æŒ‡å®š") do |v|
			$metadata[:album_name] = v
		end

		$metadata[:title_num] = nil
		opt.on("--title-num=n", String,
			"ã‚¿ã‚¤ãƒˆãƒ«ç•ªå·ã‚’æŒ‡å®š") do |v|
			$metadata[:title_num] = v
		end

		$metadata[:title_name] = nil
		opt.on("-t", "--title=str", String,
			"ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®š") do |v|
			$metadata[:title_name] = v
		end

		$metadata[:s_video_name] = []
		opt.on("--title:v=str", String,
			"ãƒ“ãƒ‡ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®š('omit'ã§å‡ºåŠ›ã—ãªã„/'auto'ã§è‡ªå‹•)") do |v|
			v = nil  if v == "auto"
			$metadata[:s_video_name] << v
		end

		$metadata[:s_audio_name] = []
		opt.on("--title:a=str", String,
			"ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®š") do |v|
			v = nil  if v == "auto"
			$metadata[:s_audio_name] << v
		end

		$metadata[:s_subtitle_name] = []
		opt.on("--title:s=str", String,
			"å­—å¹•ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®š") do |v|
			v = nil  if v == "auto"
			$metadata[:s_subtitle_name] << v
		end

		$metadata[:chapter_name] = []
		opt.on("--title:c=str", String,
			"ãƒãƒ£ãƒ—ã‚¿ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’æŒ‡å®š") do |v|
			v = nil  if v == "auto"
			$metadata[:chapter_name] << v
		end

		$video_tune = nil
		opt.on("--tune:v=str", String,
			"ãƒ“ãƒ‡ã‚ªã®ç¨®é¡(film|animation|grain|stillimage...)") do |v|
			$video_tune = v
		end

		$pullup24 = nil
		opt.on("--pullup24[=round]", String,
			"24fpsåŒ–ã™ã‚‹(near|up|down...)") do |v|
			$pullup24 = v || "near"
		end

		$force_deinterlace = nil
		opt.on("--[no-]force-deinterlace",
			"å¼·åˆ¶çš„ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ¬ãƒ¼ã‚¹è§£é™¤ã‚’è¡Œã†/è¡Œã‚ãªã„") do |v|
			$force_deinterlace = v
		end

		$quality_v = nil
		$quality_a = nil
		opt.on("--hq",
			"é«˜ç”»è³ª,é«˜éŸ³è³ªã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do
			$quality_v = "h"
			$quality_a = "h"
		end
		opt.on("--hq:v",
			"é«˜ç”»è³ªã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do
			$quality_v = "h"
		end
		opt.on("--hq:a",
			"é«˜éŸ³è³ªã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do
			$quality_a = "h"
		end
		opt.on("--lq",
			"ä½ç”»è³ª,ä½éŸ³è³ªã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do
			$quality_v = "l"
			$quality_a = "l"
		end
		opt.on("--lq:v",
			"ä½ç”»è³ªã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do
			$quality_v = "l"
		end
		opt.on("--lq:a",
			"ä½éŸ³è³ªã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do
			$quality_a = "l"
		end

		$crf_base = nil
		$crf_offset = 0
		opt.on("--crf=n", String,
			"VBRç”»è³ªã‚’æŒ‡å®šã™ã‚‹(0:ãƒ­ã‚¹ãƒ¬ã‚¹ - 21.0:ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ - 51:ä½|[+-]n)") do |v|
			if v =~ /^[+-]/
				$crf_offset = v.to_f
			else
				$crf_base = v.to_f
			end
		end

		$video_crop = nil
		opt.on("--crop=t,b,l,r", Array,
			"æ˜ åƒã‚’åˆ‡ã‚Šå–ã‚Š(ä¸Š,ä¸‹,å·¦,å³)") do |v|
			$video_crop = v.map { |v| v.to_i }
		end

		$video_aspect = nil
		opt.on("--aspect=r", String,
			"æ˜ åƒã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”(w:h)") do |v|
			$video_aspect = v
		end

		$video_rotate = nil
		opt.on("--rotate=n", String, ["90", "180", "270"],
			"æ˜ åƒã‚’å›è»¢(90|180|270)") do |v|
			$video_rotate = v.to_i
		end

		$whitepoint = nil
		opt.on("--white-point=r,g,b", Array,
			"æ˜ åƒã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ãƒ³ãƒˆ(0ï½255)") do |v|
			$whitepoint = v.map { |v| v.to_i / 255.0 }
		end

		$blackpoint = nil
		opt.on("--black-point=r,g,b", Array,
			"æ˜ åƒã®ãƒ–ãƒ©ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ(0ï½255)") do |v|
			$blackpoint = v.map { |v| v.to_i / 255.0 }
		end

		$video_gamma = nil
		opt.on("--gamma=n", Float,
			"æ˜ åƒã®ã‚¬ãƒ³ãƒè£œæ­£(0.1ã€œ1(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã€œ10)") do |v|
			$video_gamma = v
		end

		$video_saturation = nil
		opt.on("--saturation=n", Float,
			"æ˜ åƒã®å½©åº¦è£œæ­£(0ã€œ1(ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)ã€œ3.0)") do |v|
			$video_saturation = v
		end

		$flac_audio = false
		opt.on("-y", "--[no-]flacaudio",
			"éŸ³å£°ã‚’FLAC(å¯é€†åœ§ç¸®)ã§ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹") do |v|
			$flac_audio = v
		end

		$adjust_fps = true
		# opt.on("--[no-]adjust-fps",
		# 	"ãƒãƒ£ãƒ—ã‚¿ãƒ¼æ™‚é–“ã®fpsã®èª¿æ•´ã‚’è¡Œã†") do |v|
		# 	$adjust_fps = v
		# end

		$strict_length = false
		# opt.on("--[no-]strict-length",
		# 	"å†ç”Ÿæ™‚é–“ã‚’å³å¯†ã«æ¸¬å®šã™ã‚‹") do |v|
		# 	$strict_length = v
		# end

		$simple_concat = false
		opt.on("--[no-]simple-concat",
			"VOBãƒ•ã‚¡ã‚¤ãƒ«ã‚’å˜ç´”çµåˆã™ã‚‹") do |v|
			$simple_concat = v
		end

		$overwrite = false
		opt.on("-y", "--[no-]overwrite",
			"å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¦ã‚‚ä¸Šæ›¸ãã™ã‚‹") do |v|
			$overwrite = v
		end

		$testmode = false
		opt.on("--[no-]testmode",
			"ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰(é«˜é€Ÿ,ä½ç”»è³ª)") do |v|
			$testmode = v
		end

		$dryrun = false
		opt.on("--[no-]dry-run",
			"å¤‰æ›å‡¦ç†ã‚’å®Ÿéš›ã«ã¯è¡Œã‚ãªã„") do |v|
			$dryrun = v
		end

		$show_encoder = false
		opt.on("--[no-]show-encoder",
			"ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€æƒ…å ±ã‚’è¡¨ç¤º") do |v|
			$show_encoder = v
		end

		opt.parse!

		if $flac_audio
			$quality_a = nil
		end

		if !$crf_base
			case $quality_v
			when "h"
				$crf_base = 19.0
			when "l"
				$crf_base = 23.0
			else
				$crf_base = 21.0
			end
		end

		if $testmode
			$crf_base = 26.0
			$flac_audio = false
			$quality_v = "l"
			$quality_a = "l"
		end

		$crf = ($crf_base + $crf_offset).clamp(0.0, 51.0)

		if args.empty?
			if $probe_raw
				pp probe_disc_data_raw
			elsif $probe
				probe_disc
			else
				print(opt.help)
			end
		else
			args.each do |arg|
				if $show_encoder
					show_encoding_tool(arg)
				else
					vts_num = vts_num_to_i(arg)
					if $probe_raw
						pp probe_vts_data_raw(vts_num)
					elsif $probe
						probe_vts(vts_num)
					else
						dvd2mp4(vts_num)
					end
				end
			end
		end
	end

	return $rcode
end

exit main(ARGV)
